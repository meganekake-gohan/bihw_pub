"use strict";var mkg;(function(mkg){var bihw;(function(bihw){let GAME_STATE;(function(GAME_STATE){GAME_STATE[GAME_STATE["INIT"]=0]="INIT";GAME_STATE[GAME_STATE["PLAY"]=1]="PLAY";GAME_STATE[GAME_STATE["GOAL"]=2]="GOAL";GAME_STATE[GAME_STATE["DEATH"]=3]="DEATH";GAME_STATE[GAME_STATE["WAIT"]=4]="WAIT"})(GAME_STATE=bihw.GAME_STATE||(bihw.GAME_STATE={}));let GAME_MINOR_STATE;(function(GAME_MINOR_STATE){GAME_MINOR_STATE[GAME_MINOR_STATE["INIT"]=0]="INIT";GAME_MINOR_STATE[GAME_MINOR_STATE["WAIT"]=1]="WAIT";GAME_MINOR_STATE[GAME_MINOR_STATE["END"]=2]="END"})(GAME_MINOR_STATE=bihw.GAME_MINOR_STATE||(bihw.GAME_MINOR_STATE={}));let GOAL_TYPE;(function(GOAL_TYPE){GOAL_TYPE[GOAL_TYPE["ALL_KILL"]=1]="ALL_KILL";GOAL_TYPE[GOAL_TYPE["TARGET_KILL"]=2]="TARGET_KILL"})(GOAL_TYPE=bihw.GOAL_TYPE||(bihw.GOAL_TYPE={}));let BULLET_TYPE;(function(BULLET_TYPE){BULLET_TYPE[BULLET_TYPE["NONE"]=0]="NONE";BULLET_TYPE[BULLET_TYPE["STEAIGHT"]=1]="STEAIGHT";BULLET_TYPE[BULLET_TYPE["HOMING"]=2]="HOMING"})(BULLET_TYPE=bihw.BULLET_TYPE||(bihw.BULLET_TYPE={}));let ENEMY_TYPE;(function(ENEMY_TYPE){ENEMY_TYPE[ENEMY_TYPE["STOP"]=0]="STOP";ENEMY_TYPE[ENEMY_TYPE["ROT"]=1]="ROT";ENEMY_TYPE[ENEMY_TYPE["HOMING"]=2]="HOMING"})(ENEMY_TYPE=bihw.ENEMY_TYPE||(bihw.ENEMY_TYPE={}));let PLAYER_STATE;(function(PLAYER_STATE){PLAYER_STATE[PLAYER_STATE["PLAY"]=0]="PLAY";PLAYER_STATE[PLAYER_STATE["GOAL"]=1]="GOAL";PLAYER_STATE[PLAYER_STATE["DEATH"]=2]="DEATH"})(PLAYER_STATE=bihw.PLAYER_STATE||(bihw.PLAYER_STATE={}));let CONST=(()=>{class CONST{}CONST.SCREEN={width:1384,height:780};CONST.SCREEN_CENTER={x:CONST.SCREEN.width/2,y:CONST.SCREEN.height/2};CONST.UI_CAMERA={x:1e4,y:0};CONST.SCENE_KEY={PRELOAD:"scene_preload",GAME:"scene_game",START:"scene_start",END:"scene_end"};CONST.RESOURCE_KEY={JSON:{CONFIG:"json_config",STAGE_TAG:"json_stage_"},IMG:{PLAYER:"img_player",BG_TILE:"img_bg_tile",WALL:"img_wall",HURDLE:"img_hurdle",ENEMY_TAG:"img_enemy_",BULLET:"img_bullet",GOAL:"img_goal",SWITCH_UP:"img_switch_up",SWITCH_DOWN:"img_switch_down",PARTITION:"img_partition",SMOKE:"img_smoke",CIRCLE:"img_circle",FILTER:"img_filter",BUTTON_RETRY:"img_btn_retry",BUTTON_END:"img_btn_end",TITLE:"img_title",BUTTON_START:"img_btn_START",BUTTON_CONTINUE:"img_continue",BUTTON_MANUAL:"img_manual",SPEED_UP_FILTER:"img_speed_up_filter"}};CONST.DEPTH={GAME_OBJ:0,UI:100,TRANSITION:200};CONST.PARTICLES_COUNT={EXPLOSION:26,PLAYER_DEATH:64};return CONST})();bihw.CONST=CONST})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){window.onload=()=>{run()};function run(){let config={type:Phaser.CANVAS,parent:"phaser-canvas",width:bihw.CONST.SCREEN.width,height:bihw.CONST.SCREEN.height,scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{debug:false}},scene:[bihw.PreloadScene,bihw.StartScene,bihw.GameScene,bihw.EndScene],fps:{target:30}};let game=new Phaser.Game(config);bihw.GameManager.create(game)}})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){let MOVE_DIR;(function(MOVE_DIR){MOVE_DIR["RIGHT"]="right";MOVE_DIR["LEFT"]="left";MOVE_DIR["UP"]="up";MOVE_DIR["DOWN"]="down"})(MOVE_DIR=bihw.MOVE_DIR||(bihw.MOVE_DIR={}))})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class BulletManager{constructor(){this.bulletList=[]}static getInstance(){if(!BulletManager.instance){BulletManager.instance=new BulletManager}return BulletManager.instance}destroyBulletAll(){this.bulletList.forEach(b=>{b.destroy(true)});this.bulletList=[]}createBullet(scene){let bullet=new bihw.Bullet(scene,()=>{bihw.ParticlesManager.getInstance().explosion(bihw.CONST.PARTICLES_COUNT.EXPLOSION,bullet.x,bullet.y);bullet.destroy(true);this.bulletList=this.bulletList.filter(b=>b!=bullet)});this.bulletList.push(bullet);return bullet}use(x,y,angle,bulletData,id,setCollider){let bullet=this.createBullet(bihw.GameManager.getInstance().gameScene);setCollider(bullet);bullet.use(x,y,angle,bulletData,id)}update(isChangeSpeedMode,isPlayerDeath){this.bulletList.forEach(b=>{b.procUpdate(isChangeSpeedMode,isPlayerDeath)})}}bihw.BulletManager=BulletManager})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class GameManager{constructor(game){this.currentStage=0;this.isSpeedUp=false;this._game=game;this.currentStage=0;this.maxStage=0}static create(game){if(!GameManager.instance){GameManager.instance=new GameManager(game)}}static getInstance(){return GameManager.instance}get game(){return this._game}setConfig(scene){this._config=scene.cache.json.get(bihw.CONST.RESOURCE_KEY.JSON.CONFIG);this.maxStage=this._config.stage_json_list.length;return this._config}get config(){return this._config}setStageData(){this._stageData=this.gameScene.cache.json.get(bihw.CONST.RESOURCE_KEY.JSON+this.getStageJsonName())}get stageData(){return this._stageData}stageIncrement(){if(this.currentStage<this.maxStage-1){++this.currentStage;bihw.saveProgress(this.currentStage);return true}return false}resetStage(){this.currentStage=0}setStageProgress(stage){if(0<=stage&&stage<this.maxStage){this.currentStage=stage}}getStageJsonName(){return this._config.stage_json_list[this.currentStage]}get gameScene(){return this._game.scene.getScene(bihw.CONST.SCENE_KEY.GAME)}getSpeedRate(isPlayer){if(this.isSpeedUp){return isPlayer?this.config.speed_up_rate.player:this.config.speed_up_rate.other}else{return 1}}getPlayerSpeed(){return this.getSpeedRate(true)*this.config.player.speed}}bihw.GameManager=GameManager})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class ObjectManager{constructor(){this.enemyList=[];this._playerState=bihw.PLAYER_STATE.PLAY;this.switchObjList=[];this.partitionList=[];this.playerDeathTimer=0}get player(){return this._player}get playerState(){return this._playerState}static getInstance(){if(!ObjectManager.instance){ObjectManager.instance=new ObjectManager}return ObjectManager.instance}isPlayerDeath(){return this._playerState===bihw.PLAYER_STATE.DEATH}destroyObjects(){if(this.playerDeathTimer){window.clearInterval(this.playerDeathTimer)}this.field.destroy();this.startGate.destroy(true);this.goalGate.destroy();this.switchObjList.forEach(s=>{s.destroy(true)});this.partitionList.forEach(p=>{p.destroy()});this.playerShadow.destroy();this._player.destroy(true);this.enemyList.forEach(e=>{e.destroy()});this.enemyList=[];bihw.BulletManager.getInstance().destroyBulletAll()}createObjects(scene){this._playerState=bihw.PLAYER_STATE.PLAY;let stageData=bihw.GameManager.getInstance().stageData;let unitSize=bihw.GameManager.getInstance().config.unit_size;scene.physics.world.setBounds(-unitSize*.5,-unitSize*.5,unitSize*stageData.x,unitSize*stageData.y);this.field=new bihw.Field(scene,unitSize,stageData);this.creatStartGate(scene,unitSize,stageData.y,stageData.start_x);this.goalGate=new bihw.GoalGate(scene,unitSize,stageData.goal_x);this.createSwitchObj(scene,unitSize,stageData.switch_list);this.createPartition(scene,unitSize,stageData.partition_list);this._player=new bihw.Player(scene,unitSize*(stageData.start_x+.5),unitSize*stageData.y,bihw.GameManager.getInstance().config.player.hit_size,bihw.CONST.RESOURCE_KEY.IMG.PLAYER);this.playerShadow=new bihw.PlayerShadow(scene,bihw.CONST.RESOURCE_KEY.IMG.PLAYER);this.setMoveObjToStaticObj(this._player);this.createEnemy(scene,unitSize,stageData);bihw.ParticlesManager.getInstance().init(scene)}setMoveObjToStaticObj(moveObj){let scene=bihw.GameManager.getInstance().gameScene;scene.physics.add.collider(moveObj,this.field.group);this.switchObjList.forEach(obj=>{scene.physics.add.collider(moveObj,obj)});this.partitionList.forEach(obj=>{scene.physics.add.collider(moveObj,obj.sprite)})}enableHitPlayerGoal(){let scene=bihw.GameManager.getInstance().gameScene;let collier=scene.physics.add.overlap(this._player,this.goalGate.goalCollision,()=>{this._player.setCollideWorldBounds(false);scene.physics.world.removeCollider(collier);this._playerState=bihw.PLAYER_STATE.GOAL},undefined,scene)}creatStartGate(scene,unitSize,h,startX){let y=unitSize*(1+h);this.startGate=scene.add.group({key:bihw.CONST.RESOURCE_KEY.IMG.WALL,frame:0,repeat:1,setXY:{x:unitSize*startX,y:y,stepX:unitSize}})}createEnemy(scene,unitSize,stageData){stageData.enemy_list.forEach((enemyData,index)=>{let enemy=new bihw.Enemy(scene,index,unitSize,enemyData,stageData,targetID=>{this.enemyList=this.enemyList.filter(e=>e!==enemy);this.breaktTrget(true,targetID);enemy.destroy()},bihw.GameManager.getInstance().config.enemy_texture.pivot_x[enemyData.img]);scene.physics.add.collider(enemy.sprite,this._player);scene.physics.add.overlap(this._player,enemy.sprite,p=>{this.colliderPlayerToEnemy(p)},undefined,scene);this.enemyList.forEach(e=>{scene.physics.add.collider(enemy.sprite,e.sprite);scene.physics.add.overlap(enemy.sprite,e.sprite,()=>{this.colliderEnemyToEnemy(enemy,e)},undefined,scene)});this.setMoveObjToStaticObj(enemy.sprite);this.enemyList.push(enemy)})}createSwitchObj(scene,unitSize,switchDataList){if(switchDataList){switchDataList.forEach(data=>{let s=new bihw.SwitchObj(scene,unitSize*data.x,unitSize*data.y,data.target_id);this.switchObjList.push(s)})}}createPartition(scene,unitSize,partitionDataList){if(partitionDataList){partitionDataList.forEach(data=>{let p=new bihw.Partition(scene,unitSize,data);this.partitionList.push(p)})}}setCollderBullet(bullet){let scene=bihw.GameManager.getInstance().gameScene;scene.physics.add.overlap(bullet,this.field.group,b=>{b.hit()},undefined,scene);scene.physics.add.overlap(bullet,this.field.wall,b=>{b.hit()},undefined,scene);this.switchObjList.forEach(s=>{scene.physics.add.overlap(bullet,s,(b,s)=>{b.hit();s.hit(targetID=>{this.breaktTrget(false,targetID)})},undefined,scene)});this.partitionList.forEach(obj=>{scene.physics.add.overlap(bullet,obj.sprite,b=>{b.hit()},undefined,scene)});this.enemyList.forEach(enemy=>{scene.physics.add.overlap(bullet,enemy.sprite,b=>{b.hit();if(!enemy.isSelfBullet(b.enemyID)){enemy.hit()}},undefined,scene)});scene.physics.add.overlap(bullet,this.player,(b,p)=>{b.hit();this.hitPlayer(p)},undefined,scene)}colliderPlayerToEnemy(p){this.hitPlayer(p)}hitPlayer(p){if(this._playerState===bihw.PLAYER_STATE.PLAY){let create=()=>{let offset=80;let x=p.x+(Math.random()-.5)*offset;let y=p.y+(Math.random()-.5)*offset;bihw.ParticlesManager.getInstance().playerDeath(bihw.CONST.PARTICLES_COUNT.PLAYER_DEATH,x,y)};create();this.playerDeathTimer=window.setInterval(()=>{create()},600);p.hit();this.postDeathPlayer();this._playerState=bihw.PLAYER_STATE.DEATH}}postDeathPlayer(){this._player.stop();this.stopEnemy()}colliderEnemyToEnemy(e1,e2){bihw.ParticlesManager.getInstance().explosion(bihw.CONST.PARTICLES_COUNT.EXPLOSION,e1.sprite.x,e1.sprite.y);e1.hit();e2.hit()}stopEnemy(){this.enemyList.forEach(e=>{e.stop()})}initGameInit(){let stageData=bihw.GameManager.getInstance().gameScene.cache.json.get(bihw.CONST.RESOURCE_KEY.JSON+bihw.GameManager.getInstance().getStageJsonName());let unitSize=bihw.GameManager.getInstance().config.unit_size;bihw.GameManager.getInstance().gameScene.tweens.add({targets:this._player,y:unitSize*(stageData.y-1),duration:bihw.GameManager.getInstance().config.start_interval.player_move});let target={y:unitSize*(1+stageData.y)};bihw.GameManager.getInstance().gameScene.tweens.add({targets:target,y:unitSize*stageData.y,duration:bihw.GameManager.getInstance().config.start_interval.player_move,onUpdate:()=>{this.startGate.setY(target.y)}});this.goalGate.startDirection(unitSize,stageData.start_direction.goal_delay,bihw.GameManager.getInstance().config.start_interval.goal_move)}initGamePlay(){this._player.setCollideWorldBounds(true);this._player.setVelocityY(-bihw.GameManager.getInstance().getPlayerSpeed())}initGameGoal(onComplete){this.stopEnemy();let stageData=bihw.GameManager.getInstance().stageData;let unitSize=bihw.GameManager.getInstance().config.unit_size;let from=-.8*unitSize;let to=-4*unitSize;this.goalDirectionTarget=new Phaser.Math.Vector2(unitSize*(stageData.goal_x+.5),from);bihw.GameManager.getInstance().gameScene.tweens.add({targets:this.goalDirectionTarget,y:to,duration:bihw.GameManager.getInstance().config.goal_direction,onComplete:()=>{onComplete()}})}updateGameGoal(){if(this._player.y-this._player.height/2>this.goalDirectionTarget.y){this._player.homing(this.goalDirectionTarget,bihw.GameManager.getInstance().getPlayerSpeed(),5)}else{this._player.setAngle(-90);this._player.setVelocity(0,-bihw.GameManager.getInstance().getPlayerSpeed())}}update(scene,isChangeSpeedMode){this._player.procUpdate(scene,isChangeSpeedMode);this.enemyList.forEach(e=>{e.procUpdate(isChangeSpeedMode,this.isPlayerDeath(),b=>{this.setCollderBullet(b)})});bihw.BulletManager.getInstance().update(isChangeSpeedMode,this.isPlayerDeath())}breaktTrget(isEnemy,targetID){if(this.isOpneGoalGate(isEnemy,targetID)){this.openGaolate();return}this.partitionList.forEach(obj=>{if(obj.targetID===targetID){obj.hit()}})}isOpneGoalGate(isEnemy,targetID){let isOpen=false;switch(bihw.GameManager.getInstance().stageData.goal_data.type){case bihw.GOAL_TYPE.ALL_KILL:if(isEnemy&&this.enemyList.length<=0){isOpen=true}break;case bihw.GOAL_TYPE.TARGET_KILL:if(bihw.GameManager.getInstance().stageData.goal_data.target_id===targetID){isOpen=true}break}return isOpen}openGaolate(){let interval=bihw.GameManager.getInstance().config.start_interval.goal_move;this.goalGate.openDirection(bihw.GameManager.getInstance().config.unit_size,interval);window.setTimeout(()=>{this.enableHitPlayerGoal()},interval)}showPlayerShadow(scene){this.playerShadow.show(scene,()=>({x:this.player.x,y:this.player.y,angle:this.player.angle}))}hidePlayerShadow(){this.playerShadow.hide()}}bihw.ObjectManager=ObjectManager})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class ParticlesManager{constructor(){}static getInstance(){if(!ParticlesManager.instance){ParticlesManager.instance=new ParticlesManager}return ParticlesManager.instance}init(scene){this.explosionEmitter=scene.add.particles(bihw.CONST.RESOURCE_KEY.IMG.SMOKE).createEmitter({x:0,y:0,speed:{min:20,max:100},angle:{min:0,max:360},scale:{start:1,end:0},alpha:{start:0,end:.1},lifespan:1e3,quantity:0,frequency:500});this.playerDeathEmitter=scene.add.particles(bihw.CONST.RESOURCE_KEY.IMG.SMOKE).createEmitter({x:0,y:0,speed:{min:20,max:150},angle:{min:0,max:360},scale:{start:1,end:0},alpha:{start:0,end:.1},lifespan:1e3,quantity:0,frequency:500})}destroy(){this.explosionEmitter.remove();this.playerDeathEmitter.remove()}explosion(count,x,y){this.explosionEmitter.explode(count,x,y)}playerDeath(count,x,y){this.playerDeathEmitter.explode(count,x,y)}}bihw.ParticlesManager=ParticlesManager})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){const TWEEN_PARAM={0:700,1:1e3,2:50,3:500};class TransitionManager{constructor(){}get parent(){return this._parent}static getInstance(){if(!TransitionManager.instance){TransitionManager.instance=new TransitionManager}return TransitionManager.instance}init(scene,texture,x,y,size,sw,sh,depth){this.col=Math.ceil(sw/size)+1;this.row=Math.ceil(sh/size)+1;this._parent=scene.add.group();this.imgList=[];for(let j=0;j<this.row;++j){this.imgList[j]=[];for(let i=0;i<this.col;++i){let img=scene.add.image(0,0,texture);img.setOrigin(.5);if(i===0&&j===0){this.scaleX=size/img.width;this.scaleY=size/img.height}img.setScale(this.scaleX,this.scaleY);this._parent.add(img);this.imgList[j][i]=img;img.setPosition(this.scaleX*img.width*(i+.5),this.scaleY*img.height*(j+.5))}}this._parent.setDepth(depth);this._parent.incXY(x,y)}destroy(){this.imgList=[];this._parent.destroy(true)}playClose(scene,complete){this._parent.setVisible(true);for(let j=0;j<this.row;++j){for(let i=0;i<this.col;++i){this.imgList[j][i].scale=0;this.imgList[j][i].angle=0;let config=this.creatTweenConfg(this.imgList[j][i],i,j,this.scaleX,this.scaleY);scene.tweens.add(config)}}let interval=this.getInterval(this.col,this.row);window.setTimeout(()=>{complete()},interval)}playOpen(scene,complete,completeIntervalRate=1){this._parent.setVisible(true);for(let j=0;j<this.row;++j){for(let i=0;i<this.col;++i){this.imgList[j][i].setScale(this.scaleX,this.scaleY);this.imgList[j][i].angle=0;let config=this.creatTweenConfg(this.imgList[j][i],this.col-i-1,this.row-j-1,0,0);scene.tweens.add(config)}}let interval=this.getInterval(this.col,this.row);window.setTimeout(()=>{this._parent.setVisible(false)},interval);window.setTimeout(()=>{complete()},interval*completeIntervalRate)}creatTweenConfg(target,i,j,scaleX,scaleY){let l=i%2==j%2;return{targets:target,scaleX:scaleX,scaleY:scaleY,angle:l?180:-180,duration:l?TWEEN_PARAM[0]:TWEEN_PARAM[1],delay:(i+j)*TWEEN_PARAM[2]+(l?0:TWEEN_PARAM[3]),repeat:0}}getInterval(i,j){return TWEEN_PARAM[1]+(i+j)*TWEEN_PARAM[2]+TWEEN_PARAM[3]}}bihw.TransitionManager=TransitionManager})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class HomingObject extends Phaser.Physics.Arcade.Image{homing(target,speed,rotLimit){this.angle=mkg.util.rot(this.angle,this.body.position,target,rotLimit);let velo=mkg.util.polarCoord(0,0,speed,this.angle);this.setVelocity(velo.x,velo.y)}}bihw.HomingObject=HomingObject})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class Bullet extends bihw.HomingObject{constructor(scene,hitCallback){super(scene,0,0,bihw.CONST.RESOURCE_KEY.IMG.BULLET);scene.add.existing(this);scene.physics.add.existing(this);this.setActive(false);this.setVisible(false);this.speed=0;this.moveType=bihw.BULLET_TYPE.NONE;this.hitCallback=hitCallback;this._enemyID=0;this.setOrigin(.5,.5);this.setCircle(this.height*.5,this.height*.5,0)}use(x,y,angle,bulletData,id){this.setActive(true);this.setVisible(true);this.angle=angle;this.speed=bulletData.speed;this.moveType=bulletData.move_type;this._enemyID=id;let pos=mkg.util.polarCoord(x,y,this.width/2,angle);this.setPosition(pos.x,pos.y);this._setVelocity(this.speed*bihw.GameManager.getInstance().getSpeedRate(false))}_setVelocity(speed){let velo=mkg.util.newVector2(speed,this.angle);this.setVelocity(velo.x,velo.y)}hit(){this.setActive(false);this.setVisible(false);this.hitCallback()}procUpdate(isChangeSpeedMode,isPlayerDeath){if(isPlayerDeath)return;let player=bihw.ObjectManager.getInstance().player;let speedRate=bihw.GameManager.getInstance().getSpeedRate(false);switch(this.moveType){case bihw.BULLET_TYPE.HOMING:this.homing(player.body.position,this.speed*speedRate,bihw.GameManager.getInstance().config.homing_rot_max.bullet*speedRate);break;case bihw.BULLET_TYPE.STEAIGHT:if(isChangeSpeedMode){this._setVelocity(this.speed*speedRate)}break}}get enemyID(){return this._enemyID}}bihw.Bullet=Bullet})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class Enemy{constructor(scene,id,unitSize,data,stage,hitCallback,pivotX=.5){let texture=bihw.CONST.RESOURCE_KEY.IMG.ENEMY_TAG+data.img;this.enemyID=id;this.targetID=data.target_id!==undefined?data.target_id:0;this.inSearch=false;this.shotTimer=null;this.searchTween=null;this.hitCallback=hitCallback;this.isHitEffect=false;this.invincible={all:data.invincible?!!data.invincible.all:false,self:data.invincible?!!data.invincible.self:false,bullet:data.invincible?!!data.invincible.bullet:false};this.pattern=stage.enemy_pattern[data.enemy_pattern];this.searchLen=this.pattern.search!==undefined?this.pattern.search*unitSize:0;this.hp=data.hp||1;if(this.pattern.bullet_pattern){this.bulletPattern=stage.bullet_pattern[this.pattern.bullet_pattern];this.searchCircle=new Phaser.GameObjects.Image(scene,unitSize*data.x,unitSize*data.y,bihw.CONST.RESOURCE_KEY.IMG.CIRCLE);scene.add.existing(this.searchCircle);this.searchCircle.setVisible(false);this.searchCircle.setActive(false)}if(this.isMove()){this._sprite=new bihw.HomingObject(scene,unitSize*data.x,unitSize*data.y,texture);scene.physics.add.existing(this.sprite);this._sprite.setCollideWorldBounds(true)}else{this._sprite=new Phaser.Physics.Arcade.Image(scene,unitSize*data.x,unitSize*data.y,texture);scene.physics.add.existing(this.sprite,true)}this._sprite.setCircle(this._sprite.height/2);if(data.angle!==undefined){this.sprite.angle=data.angle}scene.add.existing(this.sprite);this.sprite.setOrigin(pivotX,.5)}isMove(){return this.pattern.move_type===bihw.ENEMY_TYPE.HOMING}get sprite(){return this._sprite}destroy(){this._sprite.destroy(true)}hit(){if(this.invincible.all||this.isHitEffect){this.hitEffect();return}--this.hp;if(this.hp<=0){this.destroySprite();this.hitCallback(this.targetID)}else{this.hitEffect()}}stop(){if(this.isMove()){this._sprite.setVelocity(0,0)}if(this.searchCircle){this.searchCircle.setVisible(false);this.searchCircle.setActive(false)}this.removeShotTimer();this.removeSearchTween()}destroySprite(){this.sprite.setActive(false);this.sprite.setVisible(false);if(this.searchCircle){this.searchCircle.setVisible(false);this.searchCircle.setActive(false)}this.removeShotTimer();this.removeSearchTween()}hitEffect(){if(this.isHitEffect){return}this.isHitEffect=true;this._sprite.alpha=0;let target={alpha:0};let conf=bihw.GameManager.getInstance().config.hit_effect;bihw.GameManager.getInstance().gameScene.tweens.add({targets:target,alpha:1,ease:conf.easing,duration:conf.interval,repeat:conf.repeat,onUpdate:()=>{this._sprite.alpha=target.alpha},onComplete:()=>{this.isHitEffect=false;this._sprite.alpha=1}})}procUpdate(isChangeSpeedMode,isPlayerDeath,setBulletCollider){if(isPlayerDeath)return;let player=bihw.ObjectManager.getInstance().player;if(this.searchLen!==0){this.inSearch=mkg.util.hitCirclePoint(this.sprite.x,this.sprite.y,this.searchLen,player.x,player.y)}this.move();this.shot(isChangeSpeedMode,setBulletCollider);this.updateSearchCircle(isChangeSpeedMode)}move(){if(!this.pattern.move_type||!this.pattern.search||!this.inSearch){if(this.isMove()){this.sprite.setVelocity(0,0)}return}let player=bihw.ObjectManager.getInstance().player;let speedRate=bihw.GameManager.getInstance().getSpeedRate(false);switch(this.pattern.move_type){case bihw.ENEMY_TYPE.ROT:this.sprite.angle=mkg.util.rot(this.sprite.angle,new Phaser.Math.Vector2(this.sprite.x,this.sprite.y),player.body.position,bihw.GameManager.getInstance().config.homing_rot_max.enemy*speedRate);break;case bihw.ENEMY_TYPE.HOMING:if(this.pattern.speed!==undefined&&this.pattern.speed!==0){this.sprite.homing(player.body.position,this.pattern.speed*speedRate,bihw.GameManager.getInstance().config.homing_rot_max.enemy*speedRate)}break}}shot(isChangeSpeedMode,setBulletCollider){if(!this.bulletPattern)return;if(!this.inSearch){this.removeShotTimer()}else{if(isChangeSpeedMode){this.removeShotTimer()}if(this.shotTimer===null){this.shotTimer=bihw.GameManager.getInstance().gameScene.time.addEvent({loop:true,delay:this.bulletPattern.interval/bihw.GameManager.getInstance().getSpeedRate(false),callback:()=>{if(this.bulletPattern){let barrel=this.sprite.width*(1-this.sprite.originX);let pos=mkg.util.polarCoord(this.sprite.x,this.sprite.y,barrel,this.sprite.angle);bihw.BulletManager.getInstance().use(pos.x,pos.y,this.sprite.angle,this.bulletPattern,this.enemyID,setBulletCollider)}}})}}}removeShotTimer(){if(this.shotTimer!==null){this.shotTimer.remove();this.shotTimer=null}}removeSearchTween(){if(this.searchTween!==null){this.searchTween.remove();this.searchTween=null}}isSelfBullet(id){if(this.invincible.bullet)return true;if(!this.invincible.self)return false;return id===this.enemyID}updateSearchCircle(isChangeSpeedMode){if(!!this.bulletPattern&&this.inSearch&&this.searchCircle){this.searchCircle.setPosition(this._sprite.x,this._sprite.y);if(!this.searchTween){let scale=this.searchLen/(this.searchCircle.width*.5);this.searchTween=bihw.GameManager.getInstance().gameScene.tweens.add({targets:this.searchCircle,scale:scale,delay:bihw.GameManager.getInstance().config.search_effect.delay,duration:bihw.GameManager.getInstance().config.search_effect.interval,repeat:-1,onStart:()=>{if(this.searchCircle){this.searchCircle.setVisible(true);this.searchCircle.setActive(true);this.searchCircle.scale=0}},onRepeat:()=>{if(!this.inSearch&&this.searchCircle){this.searchCircle.setVisible(false);this.searchCircle.setActive(false);this.removeSearchTween()}}})}}}}bihw.Enemy=Enemy})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class Field{constructor(scene,unitSize,stageData){this.objList=[];let w=unitSize*stageData.x;let h=unitSize*stageData.y;let tile=scene.add.tileSprite((w-unitSize)*.5,(h-unitSize)*.5,w,h,bihw.CONST.RESOURCE_KEY.IMG.BG_TILE);this.objList.push(tile);for(let x=0;x<stageData.x;++x){let keyUpper=bihw.CONST.RESOURCE_KEY.IMG.WALL;if(x===stageData.goal_x||x===stageData.goal_x+1){keyUpper=bihw.CONST.RESOURCE_KEY.IMG.BG_TILE}this.objList.push(scene.add.image(unitSize*x,-unitSize,keyUpper));let keyUnder=bihw.CONST.RESOURCE_KEY.IMG.WALL;if(x===stageData.start_x||x===stageData.start_x+1){keyUnder=bihw.CONST.RESOURCE_KEY.IMG.BG_TILE}this.objList.push(scene.add.image(unitSize*x,h,keyUnder))}for(let y=-1;y<stageData.y+1;++y){this.objList.push(scene.add.image(-unitSize,unitSize*y,bihw.CONST.RESOURCE_KEY.IMG.WALL));this.objList.push(scene.add.image(w,unitSize*y,bihw.CONST.RESOURCE_KEY.IMG.WALL))}this._wall=scene.physics.add.staticGroup();this._wall.add(new Phaser.GameObjects.Rectangle(scene,(w-unitSize)*.5,-unitSize,w,unitSize));this._wall.add(new Phaser.GameObjects.Rectangle(scene,(w-unitSize)*.5,h,w,unitSize));this._wall.add(new Phaser.GameObjects.Rectangle(scene,-unitSize,(h-unitSize)*.5,unitSize,h));this._wall.add(new Phaser.GameObjects.Rectangle(scene,w,(h-unitSize)*.5,unitSize,h));this._group=scene.physics.add.staticGroup();stageData.hurdle_list.forEach(hurdle=>{let w=hurdle.w?hurdle.w:1;let h=hurdle.h?hurdle.h:1;let tile=new Phaser.GameObjects.TileSprite(scene,unitSize*(hurdle.x-.5),unitSize*(hurdle.y-.5),unitSize*w,unitSize*h,bihw.CONST.RESOURCE_KEY.IMG.HURDLE);tile.setOrigin(0,0);this._group.add(tile,true)})}destroy(){this.objList.forEach(o=>{o.destroy(true)});this.objList=[];this._group.destroy(true);this._wall.destroy(true)}get group(){return this._group}get wall(){return this._wall}}bihw.Field=Field})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class GoalGate{constructor(scene,unitSize,x){let y=-2*unitSize;this._group=scene.add.group({key:bihw.CONST.RESOURCE_KEY.IMG.GOAL,frame:0,repeat:1,setXY:{x:unitSize*x,y:y,stepX:unitSize}});this._goalCollision=scene.physics.add.staticGroup();this._goalCollision.add(new Phaser.GameObjects.Rectangle(scene,unitSize*(x+.5),0,unitSize*2,unitSize))}get goalCollision(){return this._goalCollision}destroy(){this._group.destroy(true);this._goalCollision.destroy(true)}startDirection(unitSize,delay,interval){let target={y:-2*unitSize};bihw.GameManager.getInstance().gameScene.tweens.add({targets:target,y:-unitSize,delay:delay,duration:interval,onUpdate:()=>{this._group.setY(target.y)}})}openDirection(unitSize,interval){let target={y:-unitSize};bihw.GameManager.getInstance().gameScene.tweens.add({targets:target,y:-2*unitSize,duration:interval,onUpdate:()=>{this._group.setY(target.y)}})}}bihw.GoalGate=GoalGate})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class Partition{constructor(scene,unitSize,data){this.isHit=false;this._targetID=data.target_id;this.moveDir=data.move.dir;this.moveLen=data.move.len*unitSize;let x=unitSize*(data.x-.5);let y=unitSize*(data.y-.5);let w=data.w?data.w:1;let h=data.h?data.h:1;this._hitArea=scene.physics.add.image(x,y,bihw.CONST.RESOURCE_KEY.IMG.PARTITION);this._hitArea.setScale(w,h);this._hitArea.setVisible(false);this._hitArea.setOrigin(0,0);this._hitArea.setImmovable(true);this._sprite=scene.add.tileSprite(x,y,unitSize*w,unitSize*h,bihw.CONST.RESOURCE_KEY.IMG.PARTITION);this._sprite.setOrigin(0,0)}get sprite(){return this._hitArea}destroy(){this._sprite.destroy(true);this._hitArea.destroy(true)}get targetID(){return this._targetID}hit(){if(!this.isHit){this.isHit=true;let speed=bihw.GameManager.getInstance().config.partition.unit_speed;let length=this.moveLen;let config={targets:[this._hitArea,this._sprite],duration:length/speed*1e3,x:this._hitArea.x,y:this._hitArea.y};switch(this.moveDir){case bihw.MOVE_DIR.RIGHT:config.x+=length;break;case bihw.MOVE_DIR.LEFT:config.x-=length;break;case bihw.MOVE_DIR.UP:config.y-=length;break;case bihw.MOVE_DIR.DOWN:config.y+=length;break}bihw.GameManager.getInstance().gameScene.tweens.add(config)}}}bihw.Partition=Partition})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){const NUM=5;class PlayerShadow{constructor(scene,texture){this.objList=[];this.timer=0;this._group=scene.add.group();for(let cnt=0;cnt<NUM;++cnt){let img=scene.add.image(0,0,texture);img.setVisible(false);img.setActive(false);this._group.add(img);this.objList.push({img:img})}}destroy(){this.objList.forEach(o=>{o.img.destroy(true)});this.objList=[];this._group.destroy(true)}show(scene,getPlayerInfo){this.hide();this.timer=window.setInterval(()=>{this.emit(scene,getPlayerInfo)},500)}emit(scene,getPlayerInfo){this.objList.some(o=>{if(!o.img.active){this.creatShadow(scene,o,getPlayerInfo);return true}})}creatShadow(scene,obj,getPlayerInfo){obj.img.setActive(true);obj.img.setVisible(true);let info=getPlayerInfo();obj.img.setPosition(info.x,info.y);obj.img.angle=info.angle;obj.img.alpha=.3;obj.tween=scene.tweens.add({targets:obj.img,alpha:0,duration:1500,repeat:0,onComplete:()=>{obj.img.setActive(false);obj.img.setVisible(false);obj.tween=undefined}})}hide(){this.objList.forEach(o=>{o.img.setActive(false);o.img.setVisible(false);if(o.tween){o.tween.remove();o.tween=undefined}});if(this.timer){window.clearInterval(this.timer);this.timer=0}}get group(){return this._group}}bihw.PlayerShadow=PlayerShadow})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class Player extends bihw.HomingObject{constructor(scene,x,y,hitSize,texture,frame){super(scene,x,y,texture,frame);scene.add.existing(this);scene.physics.add.existing(this);this.body.setSize(hitSize,hitSize);this.angle=-90}hit(){}stop(){this.setVelocity(0,0)}procUpdate(scene,isChangeSpeedMode){let cursors=scene.input.keyboard.createCursorKeys();let isPress=false;let targetVec={x:0,y:0};if(cursors.left&&cursors.left.isDown){isPress=true;targetVec.x=-1}else if(cursors.right&&cursors.right.isDown){isPress=true;targetVec.x=1}if(cursors.up&&cursors.up.isDown){isPress=true;targetVec.y=-1}else if(cursors.down&&cursors.down.isDown){isPress=true;targetVec.y=1}if(!isPress){if(isChangeSpeedMode){this.updateVelo()}return}let targetAngle=Phaser.Math.RadToDeg(Math.atan2(targetVec.y,targetVec.x));let delta=mkg.util.subtractAngle(this.angle,targetAngle);let limit=bihw.GameManager.getInstance().config.player.rot_max;if(limit<delta){delta=limit}else if(delta<-limit){delta=-limit}this.angle-=delta;this.updateVelo()}updateVelo(){var velo=mkg.util.polarCoord(0,0,bihw.GameManager.getInstance().getPlayerSpeed(),this.angle);this.setVelocity(velo.x,velo.y)}}bihw.Player=Player})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class SwitchObj extends Phaser.GameObjects.Image{constructor(scene,x,y,targetID){super(scene,x,y,bihw.CONST.RESOURCE_KEY.IMG.SWITCH_UP);this.isHit=false;this.targetID=targetID;scene.add.existing(this);scene.physics.add.existing(this,true)}hit(callback){if(!this.isHit){this.isHit=true;this.setTexture(bihw.CONST.RESOURCE_KEY.IMG.SWITCH_DOWN);callback(this.targetID)}}}bihw.SwitchObj=SwitchObj})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class EndScene extends Phaser.Scene{constructor(){super(bihw.CONST.SCENE_KEY.END)}create(){this.add.text(100,100,"クリアしたンゴ\n\n何かキー押下で戻るンゴ",{fontSize:32,color:"#ffffff"});this.input.keyboard.on("keyup",()=>{this.scene.start(bihw.CONST.SCENE_KEY.START)})}}bihw.EndScene=EndScene})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class GameScene extends Phaser.Scene{constructor(){super(bihw.CONST.SCENE_KEY.GAME);this.majorState=bihw.GAME_STATE.INIT;this.minorState=bihw.GAME_MINOR_STATE.INIT;this.perSpeedUp=false;this.startDirectionCamera=new Phaser.Math.Vector2}preload(){let stageJsonName=bihw.GameManager.getInstance().getStageJsonName();this.load.json(bihw.CONST.RESOURCE_KEY.JSON+stageJsonName,"assets/json/"+stageJsonName);this.load.image(bihw.CONST.RESOURCE_KEY.IMG.PLAYER,"assets/img/player.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BG_TILE,"assets/img/grid_160x160_1.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.WALL,"assets/img/grid_160x160_2.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.HURDLE,"assets/img/grid_160x160_3.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BULLET,"assets/img/grid_32x64_1.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.GOAL,"assets/img/grid_160x160_4.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.SWITCH_DOWN,"assets/img/grid_160x160_5.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.SWITCH_UP,"assets/img/grid_160x160_6.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.PARTITION,"assets/img/grid_160x160_7.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.SMOKE,"assets/img/smoke-puff.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.CIRCLE,"assets/img/circle.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.FILTER,"assets/img/menu/filter.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BUTTON_RETRY,"assets/img/menu/button00.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BUTTON_END,"assets/img/menu/button01.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.SPEED_UP_FILTER,"assets/img/speed_up_filter.png");for(let i=1;i<=bihw.GameManager.getInstance().config.enemy_texture.num;++i){this.load.image(bihw.CONST.RESOURCE_KEY.IMG.ENEMY_TAG+i,"assets/img/enemy_texture_"+i+".png")}}create(){this.setGameState(bihw.GAME_STATE.WAIT);bihw.GameManager.getInstance().setStageData();bihw.ObjectManager.getInstance().createObjects(this);this.createUI(this,bihw.CONST.UI_CAMERA.x+bihw.CONST.SCREEN_CENTER.x,bihw.CONST.UI_CAMERA.y+bihw.CONST.SCREEN_CENTER.y,[{img:bihw.CONST.RESOURCE_KEY.IMG.BUTTON_RETRY,x:0,y:-100,offset:.5,selectCallback:()=>{this.retryGame()}},{img:bihw.CONST.RESOURCE_KEY.IMG.BUTTON_END,x:0,y:100,offset:.5,selectCallback:()=>{this.flowTitle()}}]);bihw.TransitionManager.getInstance().init(this,bihw.CONST.RESOURCE_KEY.IMG.FILTER,bihw.CONST.UI_CAMERA.x,bihw.CONST.UI_CAMERA.y,80,bihw.CONST.SCREEN.width,bihw.CONST.SCREEN.height,bihw.CONST.DEPTH.TRANSITION);this.cameras.main.ignore(this.filter);this.cameras.main.ignore(this.speedUpfilter);this.cameras.main.ignore(this.buttonList.parent);this.cameras.main.ignore(bihw.TransitionManager.getInstance().parent);this.uiCamera=this.cameras.add(0,0,bihw.CONST.SCREEN.width,bihw.CONST.SCREEN.height);this.uiCamera.setScroll(bihw.CONST.UI_CAMERA.x,bihw.CONST.UI_CAMERA.y);let keyObj=this.input.keyboard.addKey("Z");keyObj.on("down",()=>{if(this.majorState===bihw.GAME_STATE.PLAY){this.speedUp(true)}});keyObj.on("up",()=>{if(this.majorState===bihw.GAME_STATE.PLAY){this.speedUp(false)}});this.initCameraPos();bihw.TransitionManager.getInstance().playOpen(this,()=>{this.setGameState(bihw.GAME_STATE.INIT)},.3)}createUI(scene,x,y,buttonInfo){this.speedUpfilter=scene.add.image(x,y,bihw.CONST.RESOURCE_KEY.IMG.SPEED_UP_FILTER);this.speedUpfilterScale={x:bihw.CONST.SCREEN.width/this.speedUpfilter.width,y:bihw.CONST.SCREEN.height/this.speedUpfilter.height};this.speedUpfilter.setScale(this.speedUpfilterScale.x,this.speedUpfilterScale.y);this.speedUpfilter.setDepth(bihw.CONST.DEPTH.UI);this.speedUpfilter.setVisible(false);this.filter=scene.add.image(x,y,bihw.CONST.RESOURCE_KEY.IMG.FILTER);this.filter.setScale(bihw.CONST.SCREEN.width/this.filter.width,bihw.CONST.SCREEN.height/this.filter.height);this.filter.alpha=.5;this.filter.setDepth(bihw.CONST.DEPTH.UI);this.filter.setVisible(false);this.buttonList=new bihw.ButtonList(scene,x,y,buttonInfo);this.buttonList.parent.setDepth(bihw.CONST.DEPTH.UI);this.buttonList.parent.setVisible(false)}setVisibleMenu(flg){this.buttonList.parent.setVisible(flg);this.buttonList.addListenerInput();this.filter.setVisible(flg)}destroyUI(){this.buttonList.removeListenerInput();this.buttonList.destroy();this.filter.destroy(true);this.speedUpfilter.destroy(true)}initCameraPos(){let stageData=bihw.GameManager.getInstance().stageData;let unitSize=bihw.GameManager.getInstance().config.unit_size;this.startDirectionCamera.x=unitSize*stageData.start_x;this.startDirectionCamera.y=unitSize*(stageData.y-1);this.cameraFlow(this.startDirectionCamera.x,this.startDirectionCamera.y)}speedUp(enable){const scale=1.5;this.cameras.main.zoomTo(enable?scale:1,500,"Power0",true);bihw.GameManager.getInstance().isSpeedUp=enable;this.speedUpfilter.setVisible(enable);if(enable){bihw.ObjectManager.getInstance().showPlayerShadow(this);this.speedUpfilterTween=this.tweens.add({targets:this.speedUpfilter,alpha:1,scaleX:this.speedUpfilterScale.x*scale,scaleY:this.speedUpfilterScale.y*scale,duration:1500,repeat:-1,onStart:()=>{this.speedUpfilter.setScale(this.speedUpfilterScale.x,this.speedUpfilterScale.y);this.speedUpfilter.alpha=.7}})}else{bihw.ObjectManager.getInstance().hidePlayerShadow();if(this.speedUpfilterTween){this.speedUpfilterTween.remove();this.speedUpfilterTween=undefined}}}update(){switch(this.majorState){case bihw.GAME_STATE.INIT:this.procGameInit();break;case bihw.GAME_STATE.PLAY:this.procGamePlay();break;case bihw.GAME_STATE.GOAL:this.procGameGoal();break;case bihw.GAME_STATE.DEATH:this.procGameDeath();break}}setGameState(state){this.majorState=state;this.minorState=bihw.GAME_MINOR_STATE.INIT}procGameInit(){switch(this.minorState){case bihw.GAME_MINOR_STATE.INIT:this.perSpeedUp=false;this.speedUp(false);this.minorState=bihw.GAME_MINOR_STATE.WAIT;bihw.ObjectManager.getInstance().initGameInit();let stageData=bihw.GameManager.getInstance().stageData;let unitSize=bihw.GameManager.getInstance().config.unit_size;this.tweens.add({targets:this.startDirectionCamera,x:unitSize*stageData.goal_x,y:unitSize,ease:stageData.start_direction.easing,duration:stageData.start_direction.interval/2,yoyo:true,repeat:0});window.setTimeout(()=>{this.setGameState(bihw.GAME_STATE.PLAY)},stageData.start_direction.interval);break;case bihw.GAME_MINOR_STATE.END:break}this.cameraFlow(this.startDirectionCamera.x,this.startDirectionCamera.y)}procGamePlay(){var isChangeSpeedMode=false;switch(this.minorState){case bihw.GAME_MINOR_STATE.INIT:this.minorState=bihw.GAME_MINOR_STATE.WAIT;bihw.ObjectManager.getInstance().initGamePlay();break;case bihw.GAME_MINOR_STATE.WAIT:isChangeSpeedMode=this.perSpeedUp!==bihw.GameManager.getInstance().isSpeedUp;break;case bihw.GAME_MINOR_STATE.END:break}bihw.ObjectManager.getInstance().update(this,isChangeSpeedMode);switch(bihw.ObjectManager.getInstance().playerState){case bihw.PLAYER_STATE.GOAL:this.setGameState(bihw.GAME_STATE.GOAL);break;case bihw.PLAYER_STATE.DEATH:this.setGameState(bihw.GAME_STATE.DEATH);break}this.cameraFlowPlayer();this.perSpeedUp=bihw.GameManager.getInstance().isSpeedUp}cameraFlowPlayer(){let player=bihw.ObjectManager.getInstance().player;this.cameraFlow(player.x,player.y)}procGameGoal(){switch(this.minorState){case bihw.GAME_MINOR_STATE.INIT:this.speedUp(false);this.minorState=bihw.GAME_MINOR_STATE.WAIT;let goal=new Promise(resolve=>{bihw.ObjectManager.getInstance().initGameGoal(()=>{resolve()})});let transition=new Promise(resolve=>{bihw.TransitionManager.getInstance().playClose(this,()=>{resolve()})});Promise.all([goal,transition]).then(()=>{this.minorState=bihw.GAME_MINOR_STATE.END});case bihw.GAME_MINOR_STATE.WAIT:bihw.ObjectManager.getInstance().updateGameGoal();break;case bihw.GAME_MINOR_STATE.END:this.removeGameScene();if(bihw.GameManager.getInstance().stageIncrement()){this.flowNextStage()}else{this.flowEndSecen()}break}}flowNextStage(){this.scene.start(bihw.CONST.SCENE_KEY.GAME)}flowEndSecen(){this.scene.start(bihw.CONST.SCENE_KEY.END)}procGameDeath(){switch(this.minorState){case bihw.GAME_MINOR_STATE.INIT:bihw.ObjectManager.getInstance().postDeathPlayer();this.setVisibleMenu(true);this.speedUp(false);this.minorState=bihw.GAME_MINOR_STATE.WAIT;case bihw.GAME_MINOR_STATE.WAIT:break;case bihw.GAME_MINOR_STATE.END:break}this.cameraFlowPlayer()}retryGame(){this.removeGameScene();this.scene.start(bihw.CONST.SCENE_KEY.GAME)}flowTitle(){this.removeGameScene();this.scene.start(bihw.CONST.SCENE_KEY.START)}removeGameScene(){this.destroyObject();this.destroyUI();bihw.ParticlesManager.getInstance().destroy();bihw.TransitionManager.getInstance().destroy()}destroyObject(){bihw.ObjectManager.getInstance().destroyObjects();this.physics.world.colliders.destroy()}cameraFlow(x,y){let unitSize=bihw.GameManager.getInstance().config.unit_size;let stageData=bihw.GameManager.getInstance().stageData;let w=unitSize*stageData.x;let h=unitSize*stageData.y;let camera=this.cameras.main;let rate=1/camera.zoom;let minX=rate*(bihw.CONST.SCREEN.width/2)-unitSize*1.5;let maxX=w-rate*(bihw.CONST.SCREEN.width/2)+unitSize*.5;let minY=rate*(bihw.CONST.SCREEN.height/2)-unitSize*1.5;let maxY=h-rate*(bihw.CONST.SCREEN.height/2)+unitSize*.5;if(x<minX){x=minX}else if(x>maxX){x=maxX}if(y<minY){y=minY}else if(y>maxY){y=maxY}this.cameras.main.centerOn(x,y)}}bihw.GameScene=GameScene})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class PreloadScene extends Phaser.Scene{constructor(){super(bihw.CONST.SCENE_KEY.PRELOAD)}preload(){this.load.json(bihw.CONST.RESOURCE_KEY.JSON.CONFIG,"assets/json/config.json")}create(){bihw.GameManager.getInstance().setConfig(this);console.log("bih version : "+bihw.GameManager.getInstance().config.version)}update(){this.scene.start(bihw.CONST.SCENE_KEY.START)}}bihw.PreloadScene=PreloadScene})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class StartScene extends Phaser.Scene{constructor(){super(bihw.CONST.SCENE_KEY.START)}preload(){this.load.image(bihw.CONST.RESOURCE_KEY.IMG.TITLE,"assets/img/menu/title.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BUTTON_START,"assets/img/menu/button02.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BUTTON_CONTINUE,"assets/img/menu/button03.png");this.load.image(bihw.CONST.RESOURCE_KEY.IMG.BUTTON_MANUAL,"assets/img/menu/button04.png")}create(){bihw.GameManager.getInstance().resetStage();let logo=this.add.image(bihw.CONST.SCREEN_CENTER.x,bihw.CONST.SCREEN_CENTER.y-150,bihw.CONST.RESOURCE_KEY.IMG.TITLE);logo.setOrigin(.5,.5);let offset=50;let interval=110;let cnt=0;let buttnInfo=[];if(bihw.loadProgress()>0){buttnInfo.push({x:0,y:offset+interval*cnt++,img:bihw.CONST.RESOURCE_KEY.IMG.BUTTON_CONTINUE,offset:.5,selectCallback:()=>{let stage=bihw.loadProgress();bihw.GameManager.getInstance().setStageProgress(stage);this.flowGame()}})}buttnInfo.push({x:0,y:offset+interval*cnt++,img:bihw.CONST.RESOURCE_KEY.IMG.BUTTON_START,offset:.5,selectCallback:()=>{this.flowGame()}});buttnInfo.push({x:0,y:offset+interval*cnt++,img:bihw.CONST.RESOURCE_KEY.IMG.BUTTON_MANUAL,offset:.5,selectCallback:()=>{alert("工事中...")}});this.buttonList=new bihw.ButtonList(this,bihw.CONST.SCREEN_CENTER.x,bihw.CONST.SCREEN_CENTER.y,buttnInfo);this.buttonList.addListenerInput();let text=this.add.text(bihw.CONST.SCREEN.width-10,bihw.CONST.SCREEN.height-10,"Copyright © 2020 meganekakegohan",{fontSize:32,color:"#ffffff"});text.setOrigin(1,1)}flowGame(){this.destroy();this.scene.start(bihw.CONST.SCENE_KEY.GAME)}destroy(){this.buttonList.removeListenerInput();this.buttonList.destroy()}}bihw.StartScene=StartScene})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){class ButtonList{constructor(scene,x,y,buttonInfo,defaultBtnID=0){this.buttonList=[];this.selectBtnID=0;this.buttonCallback=[];this.currentScene=scene;this._parent=scene.add.group();this.selectBtnID=defaultBtnID;this.buttonTween=undefined;this.tweeningButton=undefined;this.keyRepeatTimer={interval:0,timeout:0};this.buttonList=[];this.buttonCallback=[];for(let cnt=0;cnt<buttonInfo.length;++cnt){let info=buttonInfo[cnt];let b=scene.add.image(info.x,info.y,info.img);b.setOrigin(info.offset,info.offset);this._parent.add(b);this.buttonList.push(b);this.buttonCallback.push(info.selectCallback)}this.blinkSelectButton();this.keyboard=scene.input.keyboard;this._parent.incXY(x,y)}get parent(){return this._parent}destroy(){this.stopBlinkButton();this._parent.destroy(true);this.buttonList=[]}setVisible(flg){this._parent.setVisible(flg)}blinkSelectButton(){this.blinkButton(this.buttonList[this.selectBtnID])}blinkButton(b){this.stopBlinkButton();this.buttonTween=bihw.blinkButton(b,this.currentScene);this.tweeningButton=b}stopBlinkButton(){if(this.buttonTween){this.buttonTween.remove();this.buttonTween=undefined}if(this.tweeningButton){this.tweeningButton.scale=1;this.tweeningButton=undefined}}addListenerInput(){this.keyboard.addKey("up").on("down",()=>{this.upCursor();this.setKeyRepeat(()=>{this.upCursor()})});this.keyboard.addKey("down").on("down",()=>{this.downCursor();this.setKeyRepeat(()=>{this.downCursor()})});this.keyboard.addKey("up").on("up",()=>{this.stopKeyRepeat()});this.keyboard.addKey("down").on("up",()=>{this.stopKeyRepeat()});this.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER).on("up",()=>{this.onEnter()})}upCursor(){let length=this.buttonList.length;this.selectBtnID=(this.selectBtnID-1+length)%length;this.blinkSelectButton()}downCursor(){this.selectBtnID=(this.selectBtnID+1)%this.buttonList.length;this.blinkSelectButton()}setKeyRepeat(callback){this.stopKeyRepeat();this.keyRepeatTimer.timeout=window.setTimeout(()=>{this.keyRepeatTimer.interval=window.setInterval(callback,100)},500)}stopKeyRepeat(){if(this.keyRepeatTimer.interval){window.clearInterval(this.keyRepeatTimer.interval);this.keyRepeatTimer.interval=0}if(this.keyRepeatTimer.timeout){window.clearTimeout(this.keyRepeatTimer.timeout);this.keyRepeatTimer.timeout=0}}removeListenerInput(){this.keyboard.addKey("up").removeListener("down");this.keyboard.addKey("down").removeListener("down");this.keyboard.addKey("up").removeListener("up");this.keyboard.addKey("down").removeListener("up");this.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER).removeListener("up")}onEnter(){this.buttonCallback[this.selectBtnID]()}}bihw.ButtonList=ButtonList})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));var mkg;(function(mkg){var util;(function(util){function find(arr,condition){for(let i=0;i<arr.length;++i){if(condition(arr[i])){return arr[i]}}return null}util.find=find;function polarCoord(x,y,r,angle){let dir=newVector2(r,angle);return{x:x+dir.x,y:y+dir.y}}util.polarCoord=polarCoord;function newVector2(r,angle){return new Phaser.Math.Vector2(r*Math.cos(Phaser.Math.DegToRad(angle)),r*Math.sin(Phaser.Math.DegToRad(angle)))}util.newVector2=newVector2;function subtractAngle(a,b){let result=a-b;if(result<-180){return result+360}else if(result>180){return result-360}return result}util.subtractAngle=subtractAngle;function hitCirclePoint(cx,cy,r,tx,ty){return(cx-tx)*(cx-tx)+(cy-ty)*(cy-ty)<=r*r}util.hitCirclePoint=hitCirclePoint;function rot(angle,pos,target,limit){let dir=Phaser.Math.RadToDeg(Phaser.Math.Angle.BetweenPoints(pos,target));let delta=util.subtractAngle(angle,dir);if(limit<delta){delta=limit}else if(delta<-limit){delta=-limit}return angle-delta}util.rot=rot})(util=mkg.util||(mkg.util={}))})(mkg||(mkg={}));var mkg;(function(mkg){var bihw;(function(bihw){const COOKIE_TAG={PROGRESS:"stage_progress"};function blinkButton(b,scene){return scene.tweens.add({targets:b,scale:1.2,duration:500,repeat:-1,onStart:()=>{b.scale=1}})}bihw.blinkButton=blinkButton;function saveProgress(stage){let pre=loadProgress();if(pre<stage){document.cookie=COOKIE_TAG.PROGRESS+"="+stage}}bihw.saveProgress=saveProgress;function loadProgress(){let result=0;let cookieList=document.cookie.split(";");cookieList.forEach(cookie=>{let key_vlue=cookie.split("=");if(key_vlue[0]===COOKIE_TAG.PROGRESS){result=+key_vlue[1];return}});return result}bihw.loadProgress=loadProgress})(bihw=mkg.bihw||(mkg.bihw={}))})(mkg||(mkg={}));